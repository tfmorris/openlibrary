$def with (libraries, pending_libraries)

$var title: Libraries Dashboard

$ loan_stats = get_active_loans_of_libraries()

$if ctx.user and ctx.user.is_admin():
    <div id="contentHead">
        $:render_template("borrow/navigation", path="/libraries/dashboard")
        <h1>Dashboard</h1>
    </div> 

    <div id="contentBody">
        <h2>New Registrations</h2>
        <table class="history">
            $for lib in pending_libraries:
                <tr>
                    <td style="padding: 5px; width: 460px;"><a href="$lib.url()">$(lib.name or "No Name?")</a></td>
                    <td>$lib.country</td>
                    <td>
                        $ registered_on = lib.registered_on
                            $datestr(parse_datetime(registered_on))</td>
                </tr>
            
            $if not pending_libraries:
                <tr><td><em>What's this? No new registrations? WTF?</em></td></tr>
        </table>

        <h2>Pending Libraries</h2>
        <table class="history">
            $ onhold = [lib for lib in libraries if lib.status != "approved"]
            $for lib in onhold:
                $if lib.status != "approved":
                    <tr>
                        <td style="padding: 5px; width: 460px;"><a href="$lib.url()">$(lib.name or "No Name?")</a></td>
                        <td>$lib.country</td>
                        <td>
                            $ registered_on = lib.registered_on or lib.created
                                $datestr(registered_on)</td>
                        <td style="text-align: right;">$loan_stats.get(lib.key, 0)</td>
                    </tr>
            $if not onhold:
                <tr><td><em>None found.</em></td></tr>
        </table>

        <h2>Live Libraries</h2>
        <table class="history">
            $for lib in libraries:
                $if lib.status == "approved":
                    <tr>
                        <td style="padding: 5px; width: 460px;"><a href="$lib.url()">$(lib.name or "No Name?")</a></td>
                        <td>$lib.country</td>
                        <td>
                            $ registered_on = lib.registered_on or lib.created
                                $datestr(registered_on)</td>
                        <td style="text-align: right;">$loan_stats.get(lib.key, 0)</td>
                    </tr>
        </table>
    

    </div>
$else:    
    <div id="contentHead"><h1>Permission denied.</h1></div>
    <div id="contentBody"><p>Only site administrators can see this page.</p></div>
