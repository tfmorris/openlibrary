$def with (code, lang=None)

$if lang: 
    $ lang = "lang-" + lang

$def splitlines(text):
    $ text = text.rstrip()
    $ n = text.count("\n") + 1
    <table class="code">
    <tbody>
    <tr>
    <td>
    <pre>\
    $for i in range(n):$("%4d" % (i+1))
    </pre>
    </td>
    <td><pre>$text</pre></td>
    </tr>
    </tbody>
    </table>

<div class="contenttext">$:splitlines(code)</div>