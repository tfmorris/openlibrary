$def with (page)

$var title: $page.name

<div id="contentHead">
    <div class="head">
        <h1>$page.name</h1>
        <span class="count">$page.get_edition_count() books</span>
        <div class="related">
            <span class="title">Related subjects:</span>
            $for s in page.get_related_subjects():
                <span class="tag">
                    <a href="$s.key">$s.name</a>
                </span>
        </div>
    </div>
</div>
            
<div class="clearfix"></div>

$ covers = page.get_covers(limit=12*3)

<script type="text/javascript">
var page = new Place("$page.key");
page.bookCount = $page.get_edition_count();
page.covers[0] = $:json_encode(covers[:12]);
page.covers[1] = $:json_encode(covers[12:24]);
page.covers[2] = $:json_encode(covers[24:36]);

function createTemplate(selector) {
    var code = \$(selector).html()
                    .replace(/{{/g, "<%=")
                    .replace(/}}/g, "%>");
    return Template(code);
}

page.displayCovers = function(pagenum) {
    page.getCovers(0, function(covers) {
        \$("#coversCarousel").empty().html(page.renderCovers({'covers': covers}));
        \$("#listCarousel").empty().html(page.renderList({'covers': covers}));
    });
};

function loadCoverCarousels(carousel, state) {
    if (!page.coverCarousel) {
        page.coverCarousel = carousel;
    }
    var index = carousel.first;
    page.pos = (index-1)*12;
    
    if (carousel.has(index)) {
        return;
    }
    //console.log("load", index);
    carousel.size(10);
    carousel.add(index, "loading...");
    page.getCovers(index-1, function(covers) {
        //console.log("load callback", index, covers);
        carousel.add(index, page.renderCovers({'covers': covers}));
    });
}

function loadListCarousels(carousel, state) {
    if (!page.listCarousel) {
        page.listCarousel = carousel;
    }
    var index = carousel.first;
    page.pos = index-1;
    
    if (carousel.has(index)) {
        return;
    }
    //console.log("load", index);
    carousel.size(10*12);
    carousel.add(index, "loading...");
    page.getCovers(index-1, function(covers) {
        //console.log("load callback", index, covers);
        carousel.add(index, page.renderCovers({'covers': covers}));
    });
}

\$().ready(function() {
    page.renderCovers = createTemplate("#covers-tmpl");
    page.renderList = createTemplate("#list-tmpl");
    
    page.displayCovers(0);
});

\$().ready(carousels);
\$().ready(function() {
    carouselSetup(loadCoverCarousels, loadListCarousels);
});
\$().ready(bigCharts);
</script>

<script type="text/html" class="jstemplate" id="covers-tmpl">
<% for (var i=0; i<covers.length; i++) { %>
    <% 
        var cover = covers[i]; 
        var authors = [];
        for (var j in cover.authors)
            authors.push(cover.authors[j].name);
    %>
    <div class="coverMagic">
        <% if (cover.cover_id) { %>
            <div class="SRPCover">
                <a href="{{cover.key}}" title="{{cover.title}}"><img src="http://covers.openlibrary.org/b/id/{{cover.cover_id}}-M.jpg" alt="{{cover.title}}" class="cover"/></a>
            </div>
        <% } else { %>
            <div class="SRPCoverBlank" onclick="document.location.href='{{cover.key}}';" style="display: block;">
                <div class="innerBorder">
                    <div class="BookTitle">{{cover.title}}
                        <div class="Author">{{authors.join(", ")}}</div>
                    </div>
                </div>
            </div>
        <% } %>
    </div>
<% } %>
</script>

<script type="text/html" class="jstemplate" id="list-tmpl">
<% for (var i=0; i<covers.length; i++) { %>
    <% 
        var cover = covers[i];
        var cover_url = cover.cover_id ? "http://covers.openlibrary.org/b/id/" + cover.cover_id + "-S.jpg" : "/images/icons/avatar_book-sm.png"; 
    %>
    <li>
        <span class="bookcover"><a href="{{cover.key}}"><img src="{{cover_url}}" alt="{{cover.title}}"/></a></span>
        <div class="resultTitle">
            <span class="booktitle"><a href="{{cover.key}}" class="result">{{cover.title}}</a></span>
            <span class="bookauthor">by
                <% for (var j in cover.authors) { %>
                    {{j == 0 ? "" : ", "}}
                    <a href="{{cover.authors[j].key}}">{{cover.authors[j].name}}</a>
                <% } %>
            </span>
        </div>
        <div class="resultPublisher">
            Running Pr, October 1997
            Paperback
        </div>
    </li>
<% } %>
</script>

<div id="contentLists" class="results">
    <div class="covers" id="resultsCovers">
        <ul id="coversCarousel" class="jcarousel-skin-OL">
        </ul>
    </div>

    <div id="resultsList" class="covers">
        <ul id="listCarousel" class="jcarousel-skin-OL">
        </ul>
    </div>

    <div class="jcarousel-toolbar">
        <span class="tools"><span class="label">Display:</span> <span class="list"><a class="on" href="javascript:;" id="booksCovers">Covers</a> / <a href="javascript:;" id="booksList">List</a></span></span>
    </div>
</div>

<div class="clearfix"></div>

<div id="contentMeta">

    <div id="resultsLists">
        <div class="head">
            <h2>Lists that mention $page.name</h2> 
            <span class="count">23 lists</span> 
            <span class="link">- <a href="[RELATED LISTS PAGE]">See all</a></span>
        </div>
        
        <div class="list">
            <div class="cover">
                <a href="b/OL12346915M"><img src="http://covers.openlibrary.org/b/olid/OL12346915M-S.jpg?default=http://openlibrary.org/static/images/blank.book.png" alt="[BOOK TITLE]"/></a>
            </div>
            <div class="copy">
                <div class="head">
                    <h5><a href="[LIST URL]">Vino Tinto & You</a></h5> 
                </div>
                <div class="tags">
                    3 books 
                    about red wine; 
                    by Frank Moorhouse; 
                    by Roger Ramjet...
                </div>
                <div class="owner">
                    From <a href="[USER URL]">A ruddy drinker</a>
                </div>
            </div>
        </div>
        <div class="spacer"></div>
        <div class="list">
            <div class="cover">
                <a href="b/OL12346915M"><img src="http://covers.openlibrary.org/b/olid/OL12346915M-S.jpg?default=http://openlibrary.org/static/images/blank.book.png" alt="[BOOK TITLE]"/></a>
            </div>
            <div class="copy">
                <div class="head">
                    <h5><a href="[LIST URL]">Vino Tinto & You</a></h5> 
                </div>
                <div class="tags">
                    3 books 
                    about red wine; 
                    by Frank Moorhouse; 
                    by Roger Ramjet...
                </div>
                <div class="owner">
                    From <a href="[USER URL]">A ruddy drinker</a>
                </div>
            </div>
        </div>

        <div class="spacer"></div>

        <div class="list">
            <div class="cover">
                <a href="b/OL12346915M"><img src="http://covers.openlibrary.org/b/olid/OL12346915M-S.jpg?default=http://openlibrary.org/static/images/blank.book.png" alt="[BOOK TITLE]"/></a>
            </div>
            <div class="copy">
                <div class="head">
                    <h5><a href="[LIST URL]">Vino Tinto & You</a></h5> 
                </div>
                <div class="tags">
                    3 books 
                    about red wine; 
                    by Frank Moorhouse; 
                    by Roger Ramjet...
                </div>
                <div class="owner">
                    From <a href="[USER URL]">A ruddy drinker</a>
                </div>
            </div>
        </div>

        <div class="spacer"></div>

        <div class="list">
            <div class="cover">
                <a href="b/OL12346915M"><img src="http://covers.openlibrary.org/b/olid/OL12346915M-S.jpg?default=http://openlibrary.org/static/images/blank.book.png" alt="[BOOK TITLE]"/></a>
            </div>
            <div class="copy">
                <div class="head">
                    <h5><a href="[LIST URL]">Vino Tinto & You</a></h5> 
                </div>
                <div class="tags">
                    3 books 
                    about red wine; 
                    by Frank Moorhouse; 
                    by Roger Ramjet...
                </div>
                <div class="owner">
                    From <a href="[USER URL]">A ruddy drinker</a>
                </div>
            </div>
        </div>
        
    </div>

    <div class="clearfix"></div>

    <div id="resultsAuthors">
        <div class="head">
            <h2>
                $_("Authors who write about %s", page.name)
            </h2> 
            <span class="count">$page.get_author_count() authors</span>
        </div>
        <div class="unordered">
            $for a in page.get_authors()[:5]:
                <img src="/images/avatar_author.png" height="20" alt="$a.name" align="top"/> 
                <span class="tag">
                    <a href="$a.key" title="$_('See more books by, and learn about, this author')">$a.name</a>,
                </span> 
                <span class="count">$a.count books</span>
                $if loop.last:
                    <span class="count">- <a href="[AUTHORS]">$_("See all")</a></span>
                $else:
                    <br/>
        </div>
    </div>
                
    <div class="spacer"></div>

    <div id="resultsHistory">
        <div class="head">
            <h2>
                $_("Publishing History")
            </h2>
            <span class="count"># books</span>
        </div>
        
        <div id="chartPubHistory" class="sansserif smaller" style="width:450px;height:100px;">
        </div>

        <div class="related">
            <span class="title">
                $_("Prominent publishers"):
            </span>
            $for p in page.get_publishers()[:5]:
                <span class="tag">
                    <a href="/search?ftokens=$facet_token('publishers', p.name)" title="$_('Get more information about this publisher')">$p.name</a>
                </span>
                <span class="count">
                    ($p.count),
                </span>


        </div>
    </div>
                
    <div class="clearfix"></div>
                
    <div id="resultsAbout">
        <div class="head">
            <h2>
                About $page.name
            </h2>
        </div>
                
        <iframe width="450" height="250" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" class="right illustration" src="http://www.openstreetmap.org/export/embed.html?bbox=-0.7143,44.7526,-0.419,44.914&layer=mapnik"></iframe>

        <p>
            Wikipedia...  
            <span class="smaller sansserif">More at <a href="[WIKIPEDIA LINK]">Wikipedia</a>.</span>
        </p>
                
        <div class="related">
            <span class="title">Places nearby:</span>
            <span class="tag"><a href="[SUBJECT PAGE]">Avignon</a>,</span>
        </div>

                    
    </div>
                
                
</div>