$def with (page)

$ lang = i18n.get_locale() or 'en'
$ _t = i18n.get_namespace('/type/edition')
$ _ = i18n.get_namespace('/mode/view')

$ title = page.title_prefix + ' ' + page.title

$var title: $title

$ lccn = page["lccn"] and page["lccn"][0] and ("http://lccn.loc.gov/" + page["lccn"][0])
$ oclc = page["oclc_numbers"] and page["oclc_numbers"][0] and ("http://www.worldcat.org/oclc/" + page["oclc_numbers"][0] + "?tab=details")

<div id="contentHead">
    
    $:macros.databarView(page)

    <div class="head">
        <h1>$title</h1>
            $if page.get('subtitle'): <br/><h3 class="subtitle">$page.subtitle</h3>
            $if page.authors: <br/><h2 class="author">by $:thingrepr(page.authors)</h2>
    </div>
    <br/>
    <div class="sansserif">
        $if page.get('publish_date'): $_.published_in $page.publish_date, 
        $if page.get('publishers'): by $:thingrepr(page.publishers)
        $if page.get('publish_places'): ($:thingrepr(page.publish_places).strip())
    </div> 
</div>

<script type="text/javascript">
\$().ready(bookCovers);
\$().ready(tableShow);
\$().ready(slidePanels);
</script>

<div id="contentBody">

    $:macros.databarWork(page)

    <div id="workDetails">


    <div class="illustration right">
        $:macros.CoverImage(page)
        <div class="smaller sansserif"><a href="$:page.cover_url()">Change Cover</a></div>
    </div>

    $ s1 = ["contributions", "other_titles", "work_titles", "works", "by_statement", "series", "copyright_date", "source_records", "languages", "translated_from", "edition_name", "physical_format", "physical_dimensions", "pagination", "weight"]
    $ s2 = ["isbn_10", "isbn_13", "lccn", "dewey_decimal_class", "lc_classifications", "oclc_numbers"]
    $ s3 = ["genres", "subjects"]
    $ s4 = ["download_url", "purchase_url"]
    $ sections = [s1, s2, s3, s4]

    $ rule = "-top"

    $if page.description: <p>$:format(page.description)</p>

    $if page.first_sentence: <div class="section"><span class="title">First sentence:</span> <span class="tag">$page.first_sentence</span></div>

    $if page.notes: <div class="section"><span class="title">Notes:</span> <span class="tag">$page.notes</span></div>

    $for s in sections:
        $for name in s:
            $if page[name]:
                <div class="section">
                    <span class="title">$_t[name]:</span>
                    $if name.endswith("_url"):
                        $ links = []
                        $for n in page[name]:
                            $links.append('<a href="' + n + '">' + n + '</a>')
                        $ links = NEWLINE.join(links)
                        <span class="tag">$:links</a></span>
                    $elif name == "lccn":
                        $if lccn: <span class="tag"><a href="$lccn">$:thingrepr(page[name])</a></span>
                    $elif name == "oclc_numbers":
                        $if oclc: <span class="tag"><a href="$oclc">$:thingrepr(page[name])</a></span>
                    $elif name == 'source_records':
                        <span class="tag">
                        $for src in page[name]:
                            $if src.startswith('marc:'):
                                <a href="http://openlibrary.org/show-marc/$src[5:]">Library MARC record</a>;
                            $elif src.startswith('amazon:'):
                                <a href="http://amazon.com/dp/$src[7:17]">Amazon.com</a>;
                            $elif src.startswith('ia:'):
                                <a href="http://www.archive.org/details/$src[3:]">Internet Archive</a>
                            $else:
                                $:thingrepr(src)
                        </span>
                    $elif name == "subjects":
                        <span class="tag">
                        $for subject in page[name]:
                            <a href="/search?ftokens=$:utf8(facet_token('subjects', subject.strip()))">$:utf8(thingrepr(subject)).replace('--', '&mdash;')</a>,
                        </span>
                    $else:
                        <span class="tag">$:thingrepr(page[name])</span>
                </div>
                $ rule = ""
         $ rule = "-rule"


        $if page.ocaid: <br/>
        $if not page.ocaid: <br/>


            $if page.uris:
                <div class="head">
                    <h2>External links</h2>
                </div>

                $for num in range(len(page['uris'])):
                    $if num < len(page['uri_descriptions']):
                        $ desc = page.uri_descriptions[num]
                    $else:
                        $ desc = page.uris[num]
                    <div class="section">
                        <span class="title">$desc:</span>
                        <span class="tag"><a href="$page.uris[num]">$page.uris[num]</a></span>
                    </div>

        </div>

        <div class="clearfix"></div>

            <div class="head">
                <h2>$_t.table_of_contents</h2>
                $:macros.FlourishButton("edit", changequery(m='edit'))
            </div>

            $if page.table_of_contents:
                <table>
                    $ first = "first"
                    $ table_of_contents = page.table_of_contents
                    $if isinstance(table_of_contents[0], unicode):
                        $ table_of_contents = [{'class': 'section', 'label': '', 'title': x, 'pagenum': ''} for x in table_of_contents]
                    $for i, toc in enumerate(table_of_contents):
                        <tr class="toc-$toc['class']">
                            <td class="toc-number rule $first"><b>$toc['label']</b>&nbsp;&nbsp;</td>
                            <td class="toc rule $first" style="white-space: nowrap">$toc['title']</td>
                            <td class="toc-ellipsis rule $first" style="width: 100%"></td>
                            <td class="toc-link-end rule $first" align="center">$toc['pagenum']&nbsp;&nbsp;</td>
                        </tr>
                        $ first = ""
                </table>
            $else:
                <p><em>No table of contents available.</em> <a href="$changequery(m='edit')" >Add it!</a></p>

    <div class="clearfix"></div>

    <div id="resultsAbout">
        <div class="head">
            <h2>History</h2>
            <span class="link"><a href="$changequery(m='history')">Read all</a></span>
        </div>

                    <table class="history">
                        <tbody>
                            <tr>
                                <td class="timestamp">1 hour ago</td>
                                <td class="detail">
                                    <!-- SOURCE -->
                                    <a href="[URL]">Powells</a>
                                    <!-- /SOURCE --> 
                                    told us they sell the
                                    <!-- EDITION -->
                                    <a href="[BOOK PAGE]">1983 Bantam edition</a>.
                                    <!-- /EDITION --> 
                                </td>
                            </tr>
                            <tr>
                                <td class="timestamp">3 days ago</td>
                                <td class="detail">
                                    We discovered a
                                    <!-- SCAN TYPE -->
                                    <a href="[SCANNED URL]">full-text digital version</a>
                                    <!-- /SCAN TYPE -->
                                    of the
                                    <!-- EDITION -->
                                    1963 Penguin edition
                                    <!-- /EDITION -->
                                    is available on
                                    <!-- SOURCE -->
                                    <a href="[SCAN LINK]">Google</a>.
                                    <!-- /SOURCE -->
                                </td>
                            </tr>
                            <tr>
                                <td class="timestamp">A week ago</td>
                                <td class="detail">
                                    <!-- ACTION -->
                                    A new edition
                                    <!-- /ACTION -->
                                    was added by
                                    <!-- MEMBER -->
                                    <a href="[PROFILE]">Sonny</a>,
                                    <!-- /MEMBER -->
                                    on Open Library:
                                    <!-- EDITION -->
                                    <a href="[BOOK PAGE]">1983, Bantam</a>.
                                </td>
                            </tr>
                            <tr class="reveal">
                                <td class="timestamp">&nbsp;</td>
                                <td class="detail"><a href="javascript:;" class="showmore">See more history</a></td>
                            </tr>
                            <tr class="hidden">
                                <td class="timestamp">Time stamp</td>
                                <td class="detail">Here's what happened!</td>
                            </tr>
                            <tr class="hidden">
                                <td class="timestamp">Time stamp</td>
                                <td class="detail">Here's what happened!</td>
                            </tr>
                            <tr class="hidden">
                                <td class="timestamp">Time stamp</td>
                                <td class="detail">Here's what happened!</td>
                            </tr>
                            <tr class="hidden">
                                <td class="timestamp">Time stamp</td>
                                <td class="detail">Here's what happened!</td>
                            </tr>
                            <tr class="hidden">
                                <td class="timestamp">Time stamp</td>
                                <td class="detail">Here's what happened!</td>
                            </tr>
                            <tr class="hidden">
                                <td class="timestamp">Time stamp</td>
                                <td class="detail">Here's what happened!</td>
                            </tr>
                            <tr class="hidden">
                                <td class="timestamp">Time stamp</td>
                                <td class="detail">Here's what happened!</td>
                            </tr>
                            <tr>
                                <td class="timestamp">Last month</td>
                                <td class="detail">
                                    Turned up on
                                    <!-- MEMBER -->
                                    <a href="[PROFILE]">Estelle Getty</a>'s
                                    <!-- /MEMBER -->
                                    <!-- LIST -->
                                    <a href="[LIST URL]">Snaks for Important People</a> list.
                                    <!-- /LIST -->
                                </td>
                            </tr>
                            <tr class="first">
                                <td class="timestamp">12 Nov 08</td>
                                <td class="detail">
                                    <!-- ACTION -->
                                    We imported the original source record from
                                    <!-- /ACTION -->
                                    <!-- SOURCE -->
                                    <a href="[SOURCE URL]"><strong>Library of Congress</strong></a>:
                                    <!-- /SOURCE -->
                                    <!-- EDITION -->
                                    <a href="[BOOK URL]">1962, Penguin, paperback</a>.
                                    <!-- /EDITION -->
                                </td>
                            </tr>
                        </tbody>
                    </table>

    </div>


</div>
</div>

<!-- source_records: $page.get('source_records', []) -->

$ keys = []
$for isbn in page.get('isbn_10', []) + page.get("isbn_13", []):
    $ keys.append("ISBN:" + isbn)
$for lccn in page.get('lccn', []):
    $ keys.append("LCCN:" + lccn)
$for oclc in page.get('oclc', []):
    $ keys.append("OCLC:" + oclc)

$if keys:
    <script src="http://books.google.com/books?bibkeys=$(",".join(keys))&amp;jscmd=viewapi&amp;callback=gbs_callback" type="text/javascript"></script>