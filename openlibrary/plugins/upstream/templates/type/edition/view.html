$def with (page)

$var title: $page.title

$code:
    def has_any(*keys):
        return any(page[k] for k in keys)

$def display_value(label, value):
    $if value:
        <tr>
            <td class="title"><span class="title">$label</span></td>
            <td class="tag"><span class="tag">$:thingrepr(value)</span></td>
        </tr>

$def display_identifiers(label, ids):
    <tr>
        <td class="title"><span class="title">$label</span></td>
        <td class="tag"><span class="object">
            $for id in ids:
                $ sep = cond(loop.last, "", ", ")
                $if id.url:
                    <a href="$id.url">$id.value</a>$sep
                $else:
                    ${id.value}$sep
        </span></td>
    </tr>

$def display_contributor(c):
    <li><span>$c.role</span><br />$c.name </li>

<div id="contentHead">
    
    $:macros.databarView(page)

    <div class="head">
        <h1 class="collapse">$:thingrepr(page.works)</h1>
        <div class="clearfix"></div>
        <div class="work">
        $if page.works:
            $ work = page.works[0]
            $if work.authors:
                $ author_list = ', '.join('<a href="%s">%s</a>' % (a.author.url(), a.author.name) for a in work.authors)
                <span class="editions">$_("By") $:author_list</span>
            $else:
                <span class="editions">$:_("By <em>unknown author</em>")</span>
        </div>   
    </div>
    <div class="small lightgreen sansserif" style="margin-top:10px;margin-bottom: 20px;">
        $page.works[0].edition_count edition$("s" if page.works[0].edition_count != 1 else ""): 
        <span class="small brown sansserif" style="margin-top:10px;">
                You're looking at 
                $page.publish_date
                $:thingrepr(page.publishers)
                <strong>$page.title</strong>.
        </span>
            <br />
        <a href="Previous" class="fixthis" title="PUBLISH DATE, PUBLISHER">&larr; $_("Previous")</a> 
        &bull;
        <a href="Next" class="fixthis" title="PUBLISH DATE, PUBLISHER">$_("Next") &rarr;</a> 
    </div>

</div>

<div id="contentBody">

    <div id="workDetails">

        <div id="editionCover">

            <div class="illustration">
                $:render_template('covers/book_cover', page)
                $:render_template('covers/change', page, ".bookCover img")
            </div>

        $if page.contributors:
            <div class="section">
                <h3 class="collapse">$_("Contributors")</h3>
                <ul class="contributors">
                    $for c in page.contributors:
                        $:display_contributor(c)
                </ul>
            </div>
        </div>

        <div id="editionAbout">

        $if page.description:
            <h3 class="collapse">$_("About the Book")</h3>
            $:format(page.description)

        $if page.first_sentence:
            <h3 class="collapse">$_("First Sentence")</h3>
            <p>$page.first_sentence</p>

        $ table_of_contents = page.get_table_of_contents()
        $if table_of_contents and len(table_of_contents) > 1:
            <div class="section">
            <table class="meta" id="toc-table">
            <tbody>
                <tr><td colspan="3"><h3 class="collapse">$_("Table of Contents")</h3></td></tr>
                $for toc in table_of_contents:
                    <tr class="toc-level-$toc.level">
                        <td class="toc-label">$toc.label</td>
                        <td class="toc-title">$toc.title</td>
                        <td class="toc-pagenum">$toc.pagenum</td>
                    </tr>
            </tbody>
            </table>
            </div>

        <div class="section">
            <h3 class="collapse">$_("Edition Notes")</h3>
            $if page.notes:
                $:format(page.notes)
            <table class="meta" style="margin-top: 10px">
                <tbody>
                    $:display_value(_("Title"), page.title)
                    $:display_value(_("Subtitle"), page.subtitle)
                    $:display_value(_("Edition Title"), page.edition_title)
                    $:display_value(_("Edition Name"), page.edition_name)
                    $:display_value(_("Publisher"), page.publishers)
                    $:display_value(_("Publish Date"), page.publish_date)
                    $:display_value(_("Published in"), page.publish_places)
                    $:display_value(_("Translation Of"), page.translation_of)
                    $:display_value(_("Translated From"), page.translated_from)
                    $:display_value(_("Series"), page.series)
                    $:display_value(_("Volume"), page.volume)
                    $:display_value(_("Genre"), page.genres)
                    $:display_value(_("Other Titles"), page.other_titles)
                    $:display_value(_("By Statement"), page.by_statement)
                    $:display_value(_("Copyright Date"), page.copyright_date)
                    $:display_value(_("Written in"), page.languages) 
                </tbody>
            </table>
        </div>

        <div class="section">
            <table class="meta">
            <tbody>
                <tr>
                    <td colspan="2"><h3 class="collapse">$_("ID Numbers")</h3></td>
                </tr>
                $:display_identifiers("Open Library", [storage(url=None, value=page.key.split("/")[-1])])
                $for name, values in page.get_identifiers().multi_items():
                    $:display_identifiers(values[0].label, values)
                <tr id="gbs_placeholder"></tr>
            </tbody>
            </table>
        </div>
        
        $ classifications = page.get_classifications().multi_items()
        $if classifications:
            <div class="section">
                <table class="meta">
                <tbody>
                    <tr>
                        <td colspan="2"><h3 class="collapse">$_("Classifications")</h3></td>
                    </tr>
                    $for name, values in classifications:
                        $:display_identifiers(values[0].label, values)
                </tbody>
                </table>
            </div>
            
        $if has_any("physical_format", "pagination", "physical_dimensions", "weight"):
            <div class="section">
            <table class="meta">
            <tbody>
                <tr><td colspan="2"><h3 class="collapse">$_("The Physical Object")</h3></td></tr>
                $:display_value(_("Format"), page.physical_format)
                $:display_value(_("Pagination"), page.pagination)
                $:display_value(_("Number of pages"), page.number_of_pages)
                $:display_value(_("Dimensions"), page.physical_dimensions)
                $:display_value(_("Weight"), page.weight)
            </tbody>
            </table>
            </div>

        </div>

        <div id="editionTools">
            $:macros.databarWork(page)

            <div class="section fixthis" title="$_('Other Works by author not available via Edition records')>
            $if page.authors: 
                <h6 class="collapse uppercase">$_("More by") $:thingrepr(page.authors)</h6>
            $else:
                <h6 class="collapse uppercase">$_("More by this author")</h6>

                <span class="tools"><a href="#">## $_("books")</a></span><br/>
            </div>

            $ links = page.get_links()
            $if links:
                <div class="section">
                   <h3>Links <span class="gray small sansserif">($_("that leave Open Library"))</span></h3>
                   <ul class="booklinks sansserif">
                   $for link in links:
                       <li><a href="$link.url">$link.title</a></li>
                   </ul>
                </div>
        </div>

    </div>

    <div class="clearfix"></div>

    $:render_template("lib/history", page)
</div>

<!-- source_records: $page.get('source_records', []) -->

$ keys = []
$for isbn in page.get('isbn_10', []) + page.get("isbn_13", []):
    $ keys.append("ISBN:" + isbn)
$for lccn in page.get('lccn', []):
    $ keys.append("LCCN:" + lccn)
$for oclc in page.get('oclc', []):
    $ keys.append("OCLC:" + oclc)

$if keys:
    <script type="text/javascript">
    function gbs_callback(d) {
        for (var k in d) {
            \$('#gbs_placeholder').html('<td class="title"><span class="title">Google</span></td><td class="tag"><span class="object"><a href="' + d[k]['info_url'] + '">$_("Book Search")</a></span></td>');
            break;
        }
    }
    </script>
    <script src="http://books.google.com/books?bibkeys=$(",".join(keys))&jscmd=viewapi&callback=gbs_callback" type="text/javascript"></script>