$def with (page)

$var title: $page.title

$ _x = ctx.setdefault('bodyid', 'plain')

<div id="contentBody">
    $repr(ctx.user.key)

    <div class="navBorrow">
        <a href="javascript:;" onclick="history.go(-1);"><strong>Back</strong></a>
    </div>

        <h1 class="sansserif">Borrow</h1>
        
        <div id="borrowThis" class="borrow">
            <table>
                <tbody>
                    <tr>
                        <td valign="top" style="padding-right:10px;">
                            $:render_template('covers/book_cover_small', page)
                        </td>
                        <td>
                            <span class="title">
                                $page.title
                                $if page.subtitle:
                                    <em>$page.subtitle</em>
                            </span>
                            <span class="author">
                            $ authors = page.get_authors()
                            $if authors:
                                $ author_list = ', '.join('%s' % (a.url(), truncate(a.name, 40)) for a in authors)
                                <span class="darkgrey">$_("by")</span> $:author_list
                            $else:
                                $:_('<span class="darkgrey">by</span> an <em>unknown author</em>')
                            </span>
                            <br/>
                            <span class="publisher">
                            $if page.publish_date or page.publishers:
                                $if page.publish_date:
                                    $page.publish_date
                                $else:
                                    <em>Published date unknown</em> 
                                $if page.publishers:
                                    $for p in page.publishers:
                                        , $p$cond(loop.last, "", ", ")
                                $else:
                                    , <em>publisher unknown</em>
                            </span>
                        </td>
                    </tr>


                    <!-- if borrowable AND ctx.user AND books < 5 -->
                        <tr>
                            <td>&nbsp;</td>
                            <td style="padding-top:25px;">
                            <script type="text/javascript">
                            $().ready(function(){
                                $("#borrowBook").submit(function(){
                                    $(".postSubmit").toggle();
                                    $("button[type=submit]").text("Try your download again?");
                                    return false;
                                });
                            });
                            </script>
                            <ul class="postSubmit large">
                                <li><strong>Please choose your preferred format:</strong></li>
                            </ul>
                            <p class="postSubmit hidden">Your download is in progress.</p>
                            <form method="post" action="_doborrow" id="borrowBook" name="borrowBook" class="olform">
                                <p class="large postSubmit" style="margin-left:30px;">
                                    <label>
                                    <input type="radio" name="format" value="pdf" checked="checked"/> 
                                    <strong style="padding-left:10px;">PDF</strong> 
                                    <span class="smaller grey">[file size]; high quality scans of pages</span>
                                    </label>
                                </p>
                                <p class="large postSubmit" style="margin-left:30px;">
                                    <label>
                                    <input type="radio" name="format" value="epub"/>
                                    <strong style="padding-left:10px;">ePub</strong>
                                    <span class="smaller grey">[file size]; plain text version; may contain OCR errors</span>
                                    </label>
                                </p> 
                                <div style="margin-left:15px;">
                                    <button type="submit" class="larger">Download ebook</button>
                                    <a href="javascript:;" onclick="history.go(-1);" class="red small postSubmit" style="padding-left:30px;">Cancel</a>
                                </div>
                            </form>
                            </td>
                        </tr>


                </tbody>
            </table>
        </div>
        
        <!-- if unborrowable -->
            <div class="message info">
                <h2 class="sansserif">This title is not available for borrowing.</h2>
            </div>
        <!-- elif overdrive-only -->
            <div class="message info">
                <h2 class="sansserif">An ebook may be available from your local library.</h2>
                <p><a href="this book link">Check Overdrive</a> for availability.</p>
            </div>
        <!-- elif ctx.user and books = 5 -->
            <div class="message stop">
                <h2 class="sansserif">Hang on. You've hit the lending limit of 5 concurrent titles.</h2>
                <p>Open Adobe Digital Editions to return a book you've borrowed, then try again.</p>
            </div>
        <!-- elif ctx.user and book checked-out -->
            <div class="message info">
                <h2 class="sansserif">Oh, dear. This title has been checked out.</h2>
                <p>eBooks are borrowed for two-week periods, but this one may be returned before then. Please check back!</p>
            </div>
        <!-- elif ctx.user and book checked-out by ctx.user -->
            <div class="message info">
                <h2 class="sansserif">We show that you've got this title checked out.</h2>
                <p>Open Adobe Digital Editions to read it or to return it to Open Library.</p>
            </div>
        <!-- elif not ctx.user and book checked-out -->
            <div class="message info">
                <h2 class="sansserif">This titled has been checked out.</h2>
                <p>But, you'll need to <a href="/account/login">log in</a> or <a href="/account/create">open a new account</a> to borrow any ebooks from Open library.</p>
            </div>        
        <!-- elif not ctx.user -->
            <div class="message alert">
                <h2 class="sansserif">Only Open Library account holders can borrow this book.</h2>
                <p>Log in below, or <a href="/account/create">open a new account</a>.</p>
            </div>
            <script type="text/javascript">
            //\$().ready(passwordMask);
            //\$().ready(validateForms);
            //\$().ready(validateLogin);
            </script>
            <div class="panel">
                <div class="head">
                    <h3>Log In</h3>
                </div>
                <form class="login olform" name="register" method="post">
                <div class="formElement">
                    <div class="label"><label for="username">$_("Username")</label> <span class="smaller lighter"></span></div>
                    <div class="input">
                        <input type="text" class="required" id="username" name="username" value=""/>
                    </div>
                </div>
                <div class="formElement">
                    <div class="label"><label for="password">$_("Password")</label> <span class="smaller lighter"></span></div>
                    <div class="input">
                        <input type="password" class="required"  id="password" name="password" value="" />
                    </div>
                </div>
                <div class="formElement">
                    <div class="input">
                        <input name="remember" type="checkbox" id="remember" />
                        <label for="remember" class="small">Remember me</label>
                    </div>
                </div>
                <input type="hidden" id="redirect" value="XXX - form.redirect.value" name="redirect" />
                <div class="clearfix"></div>
                <div class="formElement bottom">
                    <br/>
                    <input value="$_('Log In')" type="submit" name="submit" title="$_('Log In')"/>
                    &nbsp;
                    <a href="javascript:;" onclick="history.go(-1);" class="smaller attn">$_("Cancel")</a>
                </div>
                <div class="formElement">
                    <div class="label"></div>
                    <div class="input smaller">$:_('Did you <a href="/account/password/forgot">forget your password</a>?')
                    <br/><br/>
                    $:_('Not a member of Open Library? <a href="/account/create">Sign up now</a>.')</div>
                </div>
                </form>            
            </div>


        <!-- if ctx.user and borrow exists -->
            <div id="borrowTable" class="borrow">
                <table>
                    <thead>
                        <tr>
                            <th colspan="2" class="titles">You've checked out...</th>
                            <th class="expires">Loan expires in</th>
                        </tr>
                    </thead>
                    <tbody>
                    <!-- for each borrow -->
                        <tr>
                            <td class="cover">
                            $:render_template('covers/book_cover_small', page)
                            </td>
                            <td class="titles">
                                <span class="title">
                                $page.title
                                $if page.subtitle:
                                    <em>$page.subtitle</em>
                                </span>
                                <span class="author">
                                $ authors = page.get_authors()
                                $if authors:
                                    $ author_list = ', '.join('%s' % (a.url(), truncate(a.name, 40)) for a in authors)
                                    $_("by") $:author_list
                                $else:
                                    $:_("by an <em>unknown author</em>")
                                </span>
                                <div class="date">
                                Borrowed on <!-- borrowed date-->25 May 2010
                                </div>
                            </td>
                            <td class="expires">
                                <!-- if less than 1 day left -->
                                    <span class="red"># hours</span>
                                <!-- else -->
                                    <span class="darkgreen"># (days/week/weeks)</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <p class="large">You can <span class="highlight">return books early through Adobe Digital Editions</span>.</p>
                <p class="large">Any changes you make there <em>should</em> be reflected here when you get back and refresh this page.</p>
            </div>
            
            <p class="large">For more information on borrowing books through Open Library, <a href="">check the FAQ</a>.</p>

</div>