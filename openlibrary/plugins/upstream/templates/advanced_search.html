$def with (q, qresults, results, works_groups, facets, ftokens, ft_pairs, timings, errortext)

$ _ = i18n.get_namespace('/search')

<!-- Timings (for debugging): $timings -->

$# check for the presence of a facet token corresponding to a fulltext search selection facet
$# this is kludgy and maybe it should be done some other way, like with another plugin function
$ want_fulltext = ''
$if 'mhsncqbxgkup' in ftokens:
    $ want_fulltext = 'checked'

<div id="contentHead">
  <div class="head">
  <h1>Search Results</h1>
  </div>
</div>

<div id="contentBody">
$if errortext:
    <div class="head"><h3><span class="red"><strong>$_.error:</strong> $errortext</span></h3></div>
$else:
    <p>
    <span class="sansserif darkgreen">We found <strong>$qresults.total_results editions</strong> that match your query.</span>
    $if qresults.total_results > 0:
        $if query_param('view')=='covers':
          <span class="tools">Show: <a href="$changequery(view='list')">List</a> / <b>Covers</b></span>
        $else:
          <span class="tools">Show: <b>List</b> / <a href="$changequery(view='covers')">Covers</a></span>
    </p>

<!-- facets -->
$if facets: 
    <div id="searchFacets">
    $ selected_tokens = [token for token,tpair in ft_pairs]
    $for facet in facets:
	$ fname = facet[0]
	$ fn1 = _[fname]
	$ fentries = facet[1]
        <div class="facet">
	<div class="facetHead">$fn1</div>
        $ displayed_entries = fentries[slice(6)]
        $macros.ReorderFacets(fname, displayed_entries, selected_tokens)
	$for fentry in displayed_entries:
	    $ fval = fentry[0]
	    $ fcount = fentry[1]
	    $ ftoken = facet_token(fname, fval)
	    $ cancel = (ftoken in selected_tokens)
	    $if cancel:
                <div class="facetEntry">
                    <span class="small">
                        <a href="$changequery(ftokens=ftokens + ',' + ftoken, offset='0', remove='')">$:macros.HasFulltext(fname, fval)</a>
                    </span>
                    &nbsp;
                    <span class="smaller">
                        <a href="$changequery(remove=ftoken, ftokens=ftokens)" title="Click this to remove" class="red">[x]</a>
                    </span>
                </div>
            $else:
                <div class="facetEntry">
                    <span class="small">
                    <a href="$changequery(ftokens=ftokens + ',' + ftoken, offset='0', remove='')">$:macros.HasFulltext(fname, fval)</a>
                    </span>
                    &nbsp;
                    <span class="smaller gray">
                        $fcount
                    </span>
                </div>
        </div>

    </div>    
      
<!-- results -->
    <div id="searchResults">
    $if query_param('view')=='covers':
        $:macros.SearchResultsCovers(results)
    $else:
        $:macros.SearchResults(results)  

    <p class="small sansserif">$_.cant_find&nbsp;<a href="/addbook">$_.add_a_book</a>.</p>

    $if qresults.total_results > 20:
        <div class="clearfix"></div>
        <div class="pagination">
        $ last_page = (qresults.total_results + 19) / 20
        $ first_page = 1
        $ this_page = qresults.begin / 20 + 1
        $:macros.SearchPagination(q, first_page, last_page, this_page, 20)
        </div>
    </div>


</div>